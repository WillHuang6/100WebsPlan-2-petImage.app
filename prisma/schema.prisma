generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 使用现有的profiles表作为用户表
model Profile {
  id            String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email         String?    @unique
  display_name  String?
  avatar_url    String?
  credits       Int        @default(0)
  total_credits Int        @default(0) 
  created_at    DateTime   @default(now()) @db.Timestamptz
  updated_at    DateTime   @default(now()) @updatedAt @db.Timestamptz
  
  // 关联关系
  purchases     Purchase[]
  generations   Generation[]

  @@map("profiles")
}

// 购买记录表
model Purchase {
  id                    String   @id
  user_id               String   @db.Uuid
  user                  Profile  @relation(fields: [user_id], references: [id], onDelete: Cascade)
  product_id            String
  product_name          String
  amount                Int      // 金额(分)
  currency              String   @default("USD")
  credits               Int      // 此次购买获得的图片次数
  provider_customer_id  String
  transaction_id        String?  // Creem交易ID
  status                String   @default("completed")
  created_at            DateTime @default(now()) @db.Timestamptz
  updated_at            DateTime @default(now()) @updatedAt @db.Timestamptz

  @@map("purchase")
}

// 使用现有的generations表作为使用记录
model Generation {
  id                    String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id               String   @db.Uuid
  user                  Profile  @relation(fields: [user_id], references: [id], onDelete: Cascade)
  template_id           String?
  original_image_url    String?
  generated_image_url   String?
  status                String?
  error_message         String?
  share_token           String?
  is_public             Boolean?
  created_at            DateTime @default(now()) @db.Timestamptz
  expires_at            DateTime? @db.Timestamptz

  @@map("generations")
}

